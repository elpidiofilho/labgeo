# Ajusta Regressao
#'
#'
#' This function performs the training of the chosen regressor
#' @param df.train   Training dataframe
#' @param formula   A formula of the form y ~ x1 + x2 + ... If users don't inform formula, the first column will be used as Y values and the others columns with x1,x2....xn
#' @param preprocess pre process
#' @param regressor Choice of regressor to be used to train model. Uses  algortims names from Caret package.
#' @param nfolds     Number of folds to be build in crossvalidation
#' @param  index index
#' @param cpu_cores  Number of CPU cores to be used in parallel processing
#' @param tune_length  This argument is the number of levels for each tuning parameters that should be generated by train
#' @param metric metric used to evaluate model fit. For numeric outcome ("RMSE", "Rsquared)
#' @keywords Train kappa
#' @importFrom parallel makePSOCKcluster stopCluster
#' @importFrom doParallel registerDoParallel
#' @importFrom caret trainControl train
#' @author Elpidio Filho, \email{elpidio@ufv.br}
#' @export
#' @examples
#' regression(train,"rf",10,6)


regression <- function(df.train, formula = NULL, preprocess = NULL, regressor = "rf",
                       nfolds = 10, index = NULL, cpu_cores = 3, tune_length = 5, metric = "Rsquared"){
  #library(doParallel)
  #library(caret)
  if (nfolds == 0 ){
    method <- "none"
    tune_length <- NULL
  }
  if (nfolds == nrow(df.train)){
    method <- "LOOCV"
  } else {
    method <- "CV"
  }

  beg <- Sys.time()
  if (is.null(formula)) {
    formula <- as.formula(paste(names(df.train)[1], "~ ."))
  }
  tc <- trainControl(method = method, number = nfolds, index = index,
                    savePredictions = T, returnResamp = "all")

  if (cpu_cores > 0) {
    cl <- makePSOCKcluster(cpu_cores)
    registerDoParallel(cl)
  }
  set.seed(313)
  fit <- caret::train(formula,data = df.train, method = regressor,
                     metric = metric,
                     trControl = tc,
                     tuneLength = tune_length,
                     preProcess = preprocess)
  if (!is.null(cl)) {
    stopCluster(cl)
  }
  print(paste("Execution time: ",(Sys.time() - beg)))
  return(fit)
}
